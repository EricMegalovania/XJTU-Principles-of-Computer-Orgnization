# 流水线 CPU 设计

从多周期 CPU 的基础上进行修改

## 指令阶段分析

### 1. R-R型运算指令（add, sub, and, or）
**阶段：5个周期**

1. **IF（取指）**：从指令存储器读取指令
2. **ID（译码）**：读取rs、rt寄存器，指令译码
3. **EX（执行）**：ALU执行相应的算术/逻辑运算
4. **MEM（访存）**：**跳过**（R-R指令不需要访存）
5. **WB（写回）**：将ALU结果写入rd寄存器

### 2. R-I型运算指令（addi, ori）
**阶段：5个周期**
1. **IF（取指）**：从指令存储器读取指令
2. **ID（译码）**：读取rs寄存器，立即数符号/零扩展
3. **EX（执行）**：ALU执行寄存器与立即数的运算
4. **MEM（访存）**：**跳过**（R-I指令不需要访存）
5. **WB（写回）**：将ALU结果写入rt寄存器

### 3. 加载指令（lw）
**阶段：5个周期**
1. **IF（取指）**：从指令存储器读取指令
2. **ID（译码）**：读取base寄存器，立即数符号扩展
3. **EX（执行）**：计算有效地址（base + offset）
4. **MEM（访存）**：从数据存储器读取数据
5. **WB（写回）**：将内存数据写入rt寄存器

### 4. 存储指令（sw）
**阶段：4个周期**
1. **IF（取指）**：从指令存储器读取指令
2. **ID（译码）**：读取base和rt寄存器，立即数符号扩展
3. **EX（执行）**：计算有效地址（base + offset）
4. **MEM（访存）**：将rt寄存器数据写入数据存储器
5. **WB（写回）**：**跳过**（sw指令不需要写回）

### 5. 分支指令（beq）
**阶段：3个周期**
1. **IF（取指）**：从指令存储器读取指令
2. **ID（译码）**：读取rs、rt寄存器，计算分支目标地址
3. **EX（执行）**：比较rs和rt，根据结果更新PC
4. **MEM（访存）**：**跳过**（beq不需要访存）
5. **WB（写回）**：**跳过**（beq不需要写回）

### 6. 跳转指令（j）
**阶段：2个周期**

1. **IF（取指）**：从指令存储器读取指令
2. **ID（译码）**：计算跳转地址，更新PC
3. **EX（执行）**：**跳过**（j指令直接跳转）
4. **MEM（访存）**：**跳过**
5. **WB（写回）**：**跳过**

## 阶段详细说明

### IF阶段（所有指令）
- PC 输出到指令存储器地址
- 读取指令到 IR（指令寄存器）

### ID阶段（所有指令）
- 解析指令字段（opcode, rs, rt, rd, funct等）
- 读取寄存器堆（rs, rt）
- 立即数扩展（符号/零扩展）
- 计算分支/跳转目标地址

### EX阶段
- **运算指令**：ALU执行指定操作
- **访存指令**：计算内存有效地址
- **beq**：比较寄存器值，决定是否跳转
- **j**：跳过

### MEM阶段
- **lw**：从内存读取数据
- **sw**：向内存写入数据
- **其他指令**：跳过

### WB阶段
- **sw**：将结果写入寄存器堆
- **其他指令**：跳过此阶段
